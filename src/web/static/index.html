<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <!-- <link rel="stylesheet" href="style.css" /> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <style>
      #mapBox {
        position: relative;
      }

      #map {
        min-height: 100%;
        min-width: 100%;
      }

      #mapBar {
        margin: 1em 1em;
      }

      #searchBar {
        /* position: absolute;
        top: 1em;
        right: 1em; */
        margin: 1em 1em;
        /* z-index: 2;
        min-width: 100%; */
      }

      #currentWeatherWidget {
        margin: 1em 1em;
      }

      #forecastWidget {
        margin: 1em 1em;
      }
    </style>
  </head>
  <body>
    <div class="ui grid">
      <div class="six wide column">
        <div class="container" id="currentWeatherWidget">
          <script
            type="text/javascript"
            src="https://darksky.net/widget/graph-bar/53.3498,-6.2603/ca12/en.js?width=100%&height=350&title=Full Forecast&textColor=333333&bgColor=FFFFFF&transparency=false&skyColor=undefined&fontFamily=Default&customFont=&units=ca&timeColor=333333&tempColor=333333&currentDetailsOption=true"
          ></script>
        </div>
        <div class="container" id="forecastWidget">
          <script
            type="text/javascript"
            src="https://darksky.net/widget/graph/53.3498,-6.2603/ca12/en.js?width=100%&height=320&title=dublin&textColor=333333&bgColor=FFFFFF&transparency=false&fontFamily=Default&customFont=&units=ca&graph=temperature_graph&timeColor=333333&tempColor=333333&lineColor=333333&markerColor=333333"
          ></script>
        </div>
      </div>
      <div class="ten wide column" id="mapBox">
        <div class="row">
          <div class="ui action fluid input" id="searchBar">
            <input type="text" placeholder="Search..." id="searchBox" />
            <button class="ui button" onclick="search()">Search</button>
          </div>
        </div>
        <div class="row" id="mapBar">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <script>
      let map = null

      function getCurrentPositionPermission() {
        currentLocation().then(pos => {
          return pos
        })
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 53.35014, lng: -6.266155 },
          zoom: 13,
          styles: [
            {
              elementType: 'geometry',
              stylers: [
                {
                  color: '#ebe3cd'
                }
              ]
            },
            {
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#523735'
                }
              ]
            },
            {
              elementType: 'labels.text.stroke',
              stylers: [
                {
                  color: '#f5f1e6'
                }
              ]
            },
            {
              featureType: 'administrative',
              elementType: 'geometry.stroke',
              stylers: [
                {
                  color: '#c9b2a6'
                }
              ]
            },
            {
              featureType: 'administrative.land_parcel',
              elementType: 'geometry.stroke',
              stylers: [
                {
                  color: '#dcd2be'
                }
              ]
            },
            {
              featureType: 'administrative.land_parcel',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#ae9e90'
                }
              ]
            },
            {
              featureType: 'landscape.natural',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#dfd2ae'
                }
              ]
            },
            {
              featureType: 'poi',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#dfd2ae'
                }
              ]
            },
            {
              featureType: 'poi',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#93817c'
                }
              ]
            },
            {
              featureType: 'poi.park',
              elementType: 'geometry.fill',
              stylers: [
                {
                  color: '#a5b076'
                }
              ]
            },
            {
              featureType: 'poi.park',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#447530'
                }
              ]
            },
            {
              featureType: 'road',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#f5f1e6'
                }
              ]
            },
            {
              featureType: 'road.arterial',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#fdfcf8'
                }
              ]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#f8c967'
                }
              ]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry.stroke',
              stylers: [
                {
                  color: '#e9bc62'
                }
              ]
            },
            {
              featureType: 'road.highway.controlled_access',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#e98d58'
                }
              ]
            },
            {
              featureType: 'road.highway.controlled_access',
              elementType: 'geometry.stroke',
              stylers: [
                {
                  color: '#db8555'
                }
              ]
            },
            {
              featureType: 'road.local',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#806b63'
                }
              ]
            },
            {
              featureType: 'transit.line',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#dfd2ae'
                }
              ]
            },
            {
              featureType: 'transit.line',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#8f7d77'
                }
              ]
            },
            {
              featureType: 'transit.line',
              elementType: 'labels.text.stroke',
              stylers: [
                {
                  color: '#ebe3cd'
                }
              ]
            },
            {
              featureType: 'transit.station',
              elementType: 'geometry',
              stylers: [
                {
                  color: '#dfd2ae'
                }
              ]
            },
            {
              featureType: 'water',
              elementType: 'geometry.fill',
              stylers: [
                {
                  color: '#b9d3c2'
                }
              ]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.fill',
              stylers: [
                {
                  color: '#92998d'
                }
              ]
            }
          ]
        })
      }

      function search() {
        const address = document.querySelector('#searchBox').value
        const current = currentLocation(address)

        current.then(pos => {
          map.setCenter(pos)
          const url = `/api/v1/bikes?country=ie`
          const options = {
            method: 'GET',
            cache: 'no-cache',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            }
          }

          let lastWindow = null

          fetch(url, options)
            .then(bikes => bikes.json())
            .then(bikes => {
              for (station of bikes.features) {
                const des = {
                  lat: station.geometry.coordinates[0],
                  lng: station.geometry.coordinates[1]
                }

                if (distanceWithin(pos, des, 10000)) {
                  const latLng = new google.maps.LatLng(des.lat, des.lng)
                  const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    label: {
                      color: 'white',
                      text: '' + station.properties.available_bike_stands
                    },
                    info: station.properties
                  })

                  marker.addListener('click', event => {
                    fetch(
                      `/api/v1/pred?number=${
                        marker.info.number
                      }&city=dublin&country=ie`,
                      {
                        method: 'GET',
                        cache: 'no-cache',
                        headers: {
                          'Content-Type': 'application/json',
                          Accept: 'application/json'
                        }
                      }
                    )
                      .then(pred => pred.json())
                      .then(pred => {
                        const options = [
                          {
                            label: 'Total',
                            value: marker.info.bike_stands
                          },
                          {
                            label: 'Ava',
                            value: marker.info.available_bike_stands
                          },
                          {
                            label: 'Pred',
                            value: parseInt(pred.pred)
                          }
                        ]

                        const content = buildPopup(options)
                        const infoWindow = new google.maps.InfoWindow({
                          content: content
                        })

                        if (lastWindow !== null) {
                          lastWindow.close()
                          lastWindow = null
                        }

                        infoWindow.open(map, marker)

                        lastWindow = infoWindow
                      })
                  })
                }
              }
            })
        })
      }

      function buildPopup(options) {
        let div = document.createElement('div')
        div.classList.add('ui')
        div.classList.add('statistics')

        for (const statInfo of options) {
          let stat = document.createElement('div')
          stat.classList.add(['statistic'])

          let statValue = document.createElement('div')
          statValue.classList.add(['value'])
          statValue.textContent = statInfo.value

          let statLabel = document.createElement('div')
          statLabel.classList.add('label')
          statLabel.textContent = statInfo.label

          stat.appendChild(statValue)
          stat.appendChild(statLabel)

          div.appendChild(stat)
        }

        return div.outerHTML
      }

      function distanceWithin(src, des, range) {
        const toRadians = degree => {
          return degree * (Math.PI / 180)
        }

        const theta1 = toRadians(src.lat)
        const theta2 = toRadians(des.lat)
        const delta1 = toRadians(des.lat - src.lat)
        const delta2 = toRadians(des.lng - src.lng)

        const R = 6371e3
        const a =
          Math.pow(Math.sin(delta1 / 2), 2) +
          Math.cos(theta1) *
            Math.cos(theta2) *
            Math.pow(Math.sin(delta2 / 2), 2)

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))

        const distance = R * c

        if (distance <= range) {
          return true
        }

        return false
      }

      function currentLocation(address) {
        return new Promise((resolve, reject) => {
          if ('geolocation' in navigator && address === '') {
            navigator.geolocation.getCurrentPosition(pos => {
              resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude })
            })
          } else {
            const url = `/api/v1/coordinates?city=${address}&country=ie`
            const options = {
              method: 'GET',
              cache: 'no-cache',
              headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json'
              }
            }

            fetch(url, options)
              .then(coords => coords.json())
              .then(coords => {
                resolve({ lat: coords[0].lat, lng: coords[0].lon })
              })
          }
        })
      }
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHYYR8CVCvuGOzdM-wHwk9qLIBn8WLN5I&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>
